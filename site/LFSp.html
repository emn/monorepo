<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LFS: a primer</title>
<script>
!function(){var q=null;window.PR_SHOULD_USE_CONTINUATION=!0;
(function(){function R(a){function d(e){var b=e.charCodeAt(0);if(b!==92)return b;var a=e.charAt(1);return(b=r[a])?b:"0"<=a&&a<="7"?parseInt(e.substring(1),8):a==="u"||a==="x"?parseInt(e.substring(2),16):e.charCodeAt(1)}function g(e){if(e<32)return(e<16?"\\x0":"\\x")+e.toString(16);e=String.fromCharCode(e);return e==="\\"||e==="-"||e==="]"||e==="^"?"\\"+e:e}function b(e){var b=e.substring(1,e.length-1).match(/\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\[0-3][0-7]{0,2}|\\[0-7]{1,2}|\\[\S\s]|[^\\]/g),e=[],a=
b[0]==="^",c=["["];a&&c.push("^");for(var a=a?1:0,f=b.length;a<f;++a){var h=b[a];if(/\\[bdsw]/i.test(h))c.push(h);else{var h=d(h),l;a+2<f&&"-"===b[a+1]?(l=d(b[a+2]),a+=2):l=h;e.push([h,l]);l<65||h>122||(l<65||h>90||e.push([Math.max(65,h)|32,Math.min(l,90)|32]),l<97||h>122||e.push([Math.max(97,h)&-33,Math.min(l,122)&-33]))}}e.sort(function(e,a){return e[0]-a[0]||a[1]-e[1]});b=[];f=[];for(a=0;a<e.length;++a)h=e[a],h[0]<=f[1]+1?f[1]=Math.max(f[1],h[1]):b.push(f=h);for(a=0;a<b.length;++a)h=b[a],c.push(g(h[0])),
h[1]>h[0]&&(h[1]+1>h[0]&&c.push("-"),c.push(g(h[1])));c.push("]");return c.join("")}function s(e){for(var a=e.source.match(/\[(?:[^\\\] ]|\\[\S\s])*]|\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\\d+|\\[^\dux]|\(\?[!:=]|[()^]|[^()[\\^]+/g),c=a.length,d=[],f=0,h=0;f<c;++f){var l=a[f];l==="("?++h:"\\"===l.charAt(0)&&(l=+l.substring(1))&&(l<=h?d[l]=-1:a[f]=g(l))}for(f=1;f<d.length;++f)-1===d[f]&&(d[f]=++x);for(h=f=0;f<c;++f)l=a[f],l==="("?(++h,d[h]||(a[f]="(?:")):"\\"===l.charAt(0)&&(l=+l.substring(1))&&l<=h&&
(a[f]="\\"+d[l]);for(f=0;f<c;++f)"^"===a[f]&&"^"!==a[f+1]&&(a[f]="");if(e.ignoreCase&&m)for(f=0;f<c;++f)l=a[f],e=l.charAt(0),l.length>=2&&e==="["?a[f]=b(l):e!=="\\"&&(a[f]=l.replace(/[A-Za-z]/g,function(a){a=a.charCodeAt(0);return"["+String.fromCharCode(a&-33,a|32)+"]"}));return a.join("")}for(var x=0,m=!1,j=!1,k=0,c=a.length;k<c;++k){var i=a[k];if(i.ignoreCase)j=!0;else if(/[a-z]/i.test(i.source.replace(/\\u[\da-f]{4}|\\x[\da-f]{2}|\\[^UXux]/gi,""))){m=!0;j=!1;break}}for(var r={b:8,t:9,n:10,v:11,
f:12,r:13},n=[],k=0,c=a.length;k<c;++k){i=a[k];if(i.global||i.multiline)throw Error(""+i);n.push("(?:"+s(i)+")")}return RegExp(n.join("|"),j?"gi":"g")}function S(a,d){function g(a){var c=a.nodeType;if(c==1){if(!b.test(a.className)){for(c=a.firstChild;c;c=c.nextSibling)g(c);c=a.nodeName.toLowerCase();if("br"===c||"li"===c)s[j]="\n",m[j<<1]=x++,m[j++<<1|1]=a}}else if(c==3||c==4)c=a.nodeValue,c.length&&(c=d?c.replace(/\r\n?/g,"\n"):c.replace(/[\t\n\r ]+/g," "),s[j]=c,m[j<<1]=x,x+=c.length,m[j++<<1|1]=
a)}var b=/(?:^|\s)nocode(?:\s|$)/,s=[],x=0,m=[],j=0;g(a);return{a:s.join("").replace(/\n$/,""),d:m}}function H(a,d,g,b){d&&(a={a:d,e:a},g(a),b.push.apply(b,a.g))}function T(a){for(var d=void 0,g=a.firstChild;g;g=g.nextSibling)var b=g.nodeType,d=b===1?d?a:g:b===3?U.test(g.nodeValue)?a:d:d;return d===a?void 0:d}function D(a,d){function g(a){for(var j=a.e,k=[j,"pln"],c=0,i=a.a.match(s)||[],r={},n=0,e=i.length;n<e;++n){var z=i[n],w=r[z],t=void 0,f;if(typeof w==="string")f=!1;else{var h=b[z.charAt(0)];
if(h)t=z.match(h[1]),w=h[0];else{for(f=0;f<x;++f)if(h=d[f],t=z.match(h[1])){w=h[0];break}t||(w="pln")}if((f=w.length>=5&&"lang-"===w.substring(0,5))&&!(t&&typeof t[1]==="string"))f=!1,w="src";f||(r[z]=w)}h=c;c+=z.length;if(f){f=t[1];var l=z.indexOf(f),B=l+f.length;t[2]&&(B=z.length-t[2].length,l=B-f.length);w=w.substring(5);H(j+h,z.substring(0,l),g,k);H(j+h+l,f,I(w,f),k);H(j+h+B,z.substring(B),g,k)}else k.push(j+h,w)}a.g=k}var b={},s;(function(){for(var g=a.concat(d),j=[],k={},c=0,i=g.length;c<i;++c){var r=
g[c],n=r[3];if(n)for(var e=n.length;--e>=0;)b[n.charAt(e)]=r;r=r[1];n=""+r;k.hasOwnProperty(n)||(j.push(r),k[n]=q)}j.push(/[\S\s]/);s=R(j)})();var x=d.length;return g}function v(a){var d=[],g=[];a.tripleQuotedStrings?d.push(["str",/^(?:'''(?:[^'\\]|\\[\S\s]|''?(?=[^']))*(?:'''|$)|"""(?:[^"\\]|\\[\S\s]|""?(?=[^"]))*(?:"""|$)|'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$))/,q,"'\""]):a.multiLineStrings?d.push(["str",/^(?:'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$)|`(?:[^\\`]|\\[\S\s])*(?:`|$))/,
q,"'\"`"]):d.push(["str",/^(?:'(?:[^\n\r'\\]|\\.)*(?:'|$)|"(?:[^\n\r"\\]|\\.)*(?:"|$))/,q,"\"'"]);a.verbatimStrings&&g.push(["str",/^@"(?:[^"]|"")*(?:"|$)/,q]);var b=a.hashComments;b&&(a.cStyleComments?(b>1?d.push(["com",/^#(?:##(?:[^#]|#(?!##))*(?:###|$)|.*)/,q,"#"]):d.push(["com",/^#(?:(?:define|e(?:l|nd)if|else|error|ifn?def|include|line|pragma|undef|warning)\b|[^\n\r]*)/,q,"#"]),g.push(["str",/^<(?:(?:(?:\.\.\/)*|\/?)(?:[\w-]+(?:\/[\w-]+)+)?[\w-]+\.h(?:h|pp|\+\+)?|[a-z]\w*)>/,q])):d.push(["com",
/^#[^\n\r]*/,q,"#"]));a.cStyleComments&&(g.push(["com",/^\/\/[^\n\r]*/,q]),g.push(["com",/^\/\*[\S\s]*?(?:\*\/|$)/,q]));if(b=a.regexLiterals){var s=(b=b>1?"":"\n\r")?".":"[\\S\\s]";g.push(["lang-regex",RegExp("^(?:^^\\.?|[+-]|[!=]=?=?|\\#|%=?|&&?=?|\\(|\\*=?|[+\\-]=|->|\\/=?|::?|<<?=?|>>?>?=?|,|;|\\?|@|\\[|~|{|\\^\\^?=?|\\|\\|?=?|break|case|continue|delete|do|else|finally|instanceof|return|throw|try|typeof)\\s*("+("/(?=[^/*"+b+"])(?:[^/\\x5B\\x5C"+b+"]|\\x5C"+s+"|\\x5B(?:[^\\x5C\\x5D"+b+"]|\\x5C"+
s+")*(?:\\x5D|$))+/")+")")])}(b=a.types)&&g.push(["typ",b]);b=(""+a.keywords).replace(/^ | $/g,"");b.length&&g.push(["kwd",RegExp("^(?:"+b.replace(/[\s,]+/g,"|")+")\\b"),q]);d.push(["pln",/^\s+/,q," \r\n\t\u00a0"]);b="^.[^\\s\\w.$@'\"`/\\\\]*";a.regexLiterals&&(b+="(?!s*/)");g.push(["lit",/^@[$_a-z][\w$@]*/i,q],["typ",/^(?:[@_]?[A-Z]+[a-z][\w$@]*|\w+_t\b)/,q],["pln",/^[$_a-z][\w$@]*/i,q],["lit",/^(?:0x[\da-f]+|(?:\d(?:_\d+)*\d*(?:\.\d*)?|\.\d\+)(?:e[+-]?\d+)?)[a-z]*/i,q,"0123456789"],["pln",/^\\[\S\s]?/,
q],["pun",RegExp(b),q]);return D(d,g)}function J(a,d,g){function b(a){var c=a.nodeType;if(c==1&&!x.test(a.className))if("br"===a.nodeName)s(a),a.parentNode&&a.parentNode.removeChild(a);else for(a=a.firstChild;a;a=a.nextSibling)b(a);else if((c==3||c==4)&&g){var d=a.nodeValue,i=d.match(m);if(i)c=d.substring(0,i.index),a.nodeValue=c,(d=d.substring(i.index+i[0].length))&&a.parentNode.insertBefore(j.createTextNode(d),a.nextSibling),s(a),c||a.parentNode.removeChild(a)}}function s(a){function b(a,c){var d=
c?a.cloneNode(!1):a,e=a.parentNode;if(e){var e=b(e,1),g=a.nextSibling;e.appendChild(d);for(var i=g;i;i=g)g=i.nextSibling,e.appendChild(i)}return d}for(;!a.nextSibling;)if(a=a.parentNode,!a)return;for(var a=b(a.nextSibling,0),d;(d=a.parentNode)&&d.nodeType===1;)a=d;c.push(a)}for(var x=/(?:^|\s)nocode(?:\s|$)/,m=/\r\n?|\n/,j=a.ownerDocument,k=j.createElement("li");a.firstChild;)k.appendChild(a.firstChild);for(var c=[k],i=0;i<c.length;++i)b(c[i]);d===(d|0)&&c[0].setAttribute("value",d);var r=j.createElement("ol");
r.className="linenums";for(var d=Math.max(0,d-1|0)||0,i=0,n=c.length;i<n;++i)k=c[i],k.className="L"+(i+d)%10,k.firstChild||k.appendChild(j.createTextNode("\u00a0")),r.appendChild(k);a.appendChild(r)}function p(a,d){for(var g=d.length;--g>=0;){var b=d[g];F.hasOwnProperty(b)?E.console&&console.warn("cannot override language handler %s",b):F[b]=a}}function I(a,d){if(!a||!F.hasOwnProperty(a))a=/^\s*</.test(d)?"default-markup":"default-code";return F[a]}function K(a){var d=a.h;try{var g=S(a.c,a.i),b=g.a;
a.a=b;a.d=g.d;a.e=0;I(d,b)(a);var s=/\bMSIE\s(\d+)/.exec(navigator.userAgent),s=s&&+s[1]<=8,d=/\n/g,x=a.a,m=x.length,g=0,j=a.d,k=j.length,b=0,c=a.g,i=c.length,r=0;c[i]=m;var n,e;for(e=n=0;e<i;)c[e]!==c[e+2]?(c[n++]=c[e++],c[n++]=c[e++]):e+=2;i=n;for(e=n=0;e<i;){for(var p=c[e],w=c[e+1],t=e+2;t+2<=i&&c[t+1]===w;)t+=2;c[n++]=p;c[n++]=w;e=t}c.length=n;var f=a.c,h;if(f)h=f.style.display,f.style.display="none";try{for(;b<k;){var l=j[b+2]||m,B=c[r+2]||m,t=Math.min(l,B),A=j[b+1],G;if(A.nodeType!==1&&(G=x.substring(g,
t))){s&&(G=G.replace(d,"\r"));A.nodeValue=G;var L=A.ownerDocument,o=L.createElement("span");o.className=c[r+1];var v=A.parentNode;v.replaceChild(o,A);o.appendChild(A);g<l&&(j[b+1]=A=L.createTextNode(x.substring(t,l)),v.insertBefore(A,o.nextSibling))}g=t;g>=l&&(b+=2);g>=B&&(r+=2)}}finally{if(f)f.style.display=h}}catch(u){E.console&&console.log(u&&u.stack||u)}}var E=window,y=["break,continue,do,else,for,if,return,while"],C=[[y,"auto,case,char,const,default,double,enum,extern,float,goto,inline,int,long,register,short,signed,sizeof,static,struct,switch,typedef,union,unsigned,void,volatile"],
"catch,class,delete,false,import,new,operator,private,protected,public,this,throw,true,try,typeof"],M=[C,"alignof,align_union,asm,axiom,bool,concept,concept_map,const_cast,constexpr,decltype,delegate,dynamic_cast,explicit,export,friend,generic,late_check,mutable,namespace,nullptr,property,reinterpret_cast,static_assert,static_cast,template,typeid,typename,using,virtual,where"],V=[C,"abstract,assert,boolean,byte,extends,final,finally,implements,import,instanceof,interface,null,native,package,strictfp,super,synchronized,throws,transient"],
N=[C,"abstract,as,base,bool,by,byte,checked,decimal,delegate,descending,dynamic,event,finally,fixed,foreach,from,group,implicit,in,interface,internal,into,is,let,lock,null,object,out,override,orderby,params,partial,readonly,ref,sbyte,sealed,stackalloc,string,select,uint,ulong,unchecked,unsafe,ushort,var,virtual,where"],C=[C,"debugger,eval,export,function,get,null,set,undefined,var,with,Infinity,NaN"],O=[y,"and,as,assert,class,def,del,elif,except,exec,finally,from,global,import,in,is,lambda,nonlocal,not,or,pass,print,raise,try,with,yield,False,True,None"],
P=[y,"alias,and,begin,case,class,def,defined,elsif,end,ensure,false,in,module,next,nil,not,or,redo,rescue,retry,self,super,then,true,undef,unless,until,when,yield,BEGIN,END"],W=[y,"as,assert,const,copy,drop,enum,extern,fail,false,fn,impl,let,log,loop,match,mod,move,mut,priv,pub,pure,ref,self,static,struct,true,trait,type,unsafe,use"],y=[y,"case,done,elif,esac,eval,fi,function,in,local,set,then,until"],Q=/^(DIR|FILE|vector|(de|priority_)?queue|list|stack|(const_)?iterator|(multi)?(set|map)|bitset|u?(int|float)\d*)\b/,
U=/\S/,X=v({keywords:[M,N,C,"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",O,P,y],hashComments:!0,cStyleComments:!0,multiLineStrings:!0,regexLiterals:!0}),F={};p(X,["default-code"]);p(D([],[["pln",/^[^<?]+/],["dec",/^<!\w[^>]*(?:>|$)/],["com",/^<\!--[\S\s]*?(?:--\>|$)/],["lang-",/^<\?([\S\s]+?)(?:\?>|$)/],["lang-",/^<%([\S\s]+?)(?:%>|$)/],["pun",/^(?:<[%?]|[%?]>)/],["lang-",
/^<xmp\b[^>]*>([\S\s]+?)<\/xmp\b[^>]*>/i],["lang-js",/^<script\b[^>]*>([\S\s]*?)(<\/script\b[^>]*>)/i],["lang-css",/^<style\b[^>]*>([\S\s]*?)(<\/style\b[^>]*>)/i],["lang-in.tag",/^(<\/?[a-z][^<>]*>)/i] ]),["default-markup","htm","html","mxml","xhtml","xml","xsl"]);p(D([["pln",/^\s+/,q," \t\r\n"],["atv",/^(?:"[^"]*"?|'[^']*'?)/,q,"\"'"] ],[["tag",/^^<\/?[a-z](?:[\w-.:]*\w)?|\/?>$/i],["atn",/^(?!style[\s=]|on)[a-z](?:[\w:-]*\w)?/i],["lang-uq.val",/^=\s*([^\s"'>]*(?:[^\s"'/>]|\/(?=\s)))/],["pun",/^[/<->]+/],
["lang-js",/^on\w+\s*=\s*"([^"]+)"/i],["lang-js",/^on\w+\s*=\s*'([^']+)'/i],["lang-js",/^on\w+\s*=\s*([^\s"'>]+)/i],["lang-css",/^style\s*=\s*"([^"]+)"/i],["lang-css",/^style\s*=\s*'([^']+)'/i],["lang-css",/^style\s*=\s*([^\s"'>]+)/i] ]),["in.tag"]);p(D([],[["atv",/^[\S\s]+/] ]),["uq.val"]);p(v({keywords:M,hashComments:!0,cStyleComments:!0,types:Q}),["c","cc","cpp","cxx","cyc","m"]);p(v({keywords:"null,true,false"}),["json"]);p(v({keywords:N,hashComments:!0,cStyleComments:!0,verbatimStrings:!0,types:Q}),
["cs"]);p(v({keywords:V,cStyleComments:!0}),["java"]);p(v({keywords:y,hashComments:!0,multiLineStrings:!0}),["bash","bsh","csh","sh"]);p(v({keywords:O,hashComments:!0,multiLineStrings:!0,tripleQuotedStrings:!0}),["cv","py","python"]);p(v({keywords:"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",hashComments:!0,multiLineStrings:!0,regexLiterals:2}),["perl","pl","pm"]);p(v({keywords:P,
hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["rb","ruby"]);p(v({keywords:C,cStyleComments:!0,regexLiterals:!0}),["javascript","js"]);p(v({keywords:"all,and,by,catch,class,else,extends,false,finally,for,if,in,is,isnt,loop,new,no,not,null,of,off,on,or,return,super,then,throw,true,try,unless,until,when,while,yes",hashComments:3,cStyleComments:!0,multilineStrings:!0,tripleQuotedStrings:!0,regexLiterals:!0}),["coffee"]);p(v({keywords:W,cStyleComments:!0,multilineStrings:!0}),["rc","rs","rust"]);
p(D([],[["str",/^[\S\s]+/] ]),["regex"]);var Y=E.PR={createSimpleLexer:D,registerLangHandler:p,sourceDecorator:v,PR_ATTRIB_NAME:"atn",PR_ATTRIB_VALUE:"atv",PR_COMMENT:"com",PR_DECLARATION:"dec",PR_KEYWORD:"kwd",PR_LITERAL:"lit",PR_NOCODE:"nocode",PR_PLAIN:"pln",PR_PUNCTUATION:"pun",PR_SOURCE:"src",PR_STRING:"str",PR_TAG:"tag",PR_TYPE:"typ",prettyPrintOne:E.prettyPrintOne=function(a,d,g){var b=document.createElement("div");b.innerHTML="<pre>"+a+"</pre>";b=b.firstChild;g&&J(b,g,!0);K({h:d,j:g,c:b,i:1});
return b.innerHTML},prettyPrint:E.prettyPrint=function(a,d){function g(){for(var b=E.PR_SHOULD_USE_CONTINUATION?c.now()+250:Infinity;i<p.length&&c.now()<b;i++){for(var d=p[i],j=h,k=d;k=k.previousSibling;){var m=k.nodeType,o=(m===7||m===8)&&k.nodeValue;if(o?!/^\??prettify\b/.test(o):m!==3||/\S/.test(k.nodeValue))break;if(o){j={};o.replace(/\b(\w+)=([\w%+\-.:]+)/g,function(a,b,c){j[b]=c});break}}k=d.className;if((j!==h||e.test(k))&&!v.test(k)){m=!1;for(o=d.parentNode;o;o=o.parentNode)if(f.test(o.tagName)&&
o.className&&e.test(o.className)){m=!0;break}if(!m){d.className+=" prettyprinted";m=j.lang;if(!m){var m=k.match(n),y;if(!m&&(y=T(d))&&t.test(y.tagName))m=y.className.match(n);m&&(m=m[1])}if(w.test(d.tagName))o=1;else var o=d.currentStyle,u=s.defaultView,o=(o=o?o.whiteSpace:u&&u.getComputedStyle?u.getComputedStyle(d,q).getPropertyValue("white-space"):0)&&"pre"===o.substring(0,3);u=j.linenums;if(!(u=u==="true"||+u))u=(u=k.match(/\blinenums\b(?::(\d+))?/))?u[1]&&u[1].length?+u[1]:!0:!1;u&&J(d,u,o);r=
{h:m,c:d,j:u,i:o};K(r)}}}i<p.length?setTimeout(g,250):"function"===typeof a&&a()}for(var b=d||document.body,s=b.ownerDocument||document,b=[b.getElementsByTagName("pre"),b.getElementsByTagName("code"),b.getElementsByTagName("xmp")],p=[],m=0;m<b.length;++m)for(var j=0,k=b[m].length;j<k;++j)p.push(b[m][j]);var b=q,c=Date;c.now||(c={now:function(){return+new Date}});var i=0,r,n=/\blang(?:uage)?-([\w.]+)(?!\S)/,e=/\bprettyprint\b/,v=/\bprettyprinted\b/,w=/pre|xmp/i,t=/^code$/i,f=/^(?:pre|code|xmp)$/i,
h={};g()}};typeof define==="function"&&define.amd&&define("google-code-prettify",[],function(){return Y})})();}()
</script>
<style>
.pln{color:#1b181b}.str{color:#918b3b}.kwd{color:#7b59c0}.com{color:#9e8f9e}.typ{color:#516aec}.lit{color:#a65926}.clo,.opn,.pun{color:#1b181b}.tag{color:#ca402b}.atn{color:#a65926}.atv{color:#159393}.dec{color:#a65926}.var{color:#ca402b}.fun{color:#516aec}pre.prettyprint{background:#f7f3f7;color:#ab9bab;font-family:Menlo,Consolas,"Bitstream Vera Sans Mono","DejaVu Sans Mono",Monaco,monospace;font-size:12px;line-height:1.5;border:1px solid #d8cad8;padding:10px}ol.linenums{margin-top:0;margin-bottom:0}
body{min-width:200px;max-width:850px;margin:0 auto;padding:30px;}.chapter-nav{font-size: 10pt;}a:link,a:visited{color:#00f}.codeblock_name,code,pre.prettyprint{font-family:Monaco,"Lucida Console",monospace}body{font-size:14pt}.codeblock_name,.math,.seealso,code{font-size:10pt}.codeblock{page-break-inside:avoid;padding-bottom:15px}.math{text-indent:0}pre.prettyprint{font-size:10pt;padding:10px;border-radius:10px;border:none;white-space:pre-wrap}.codeblock_name{margin-top:1.25em;display:block}a:link{text-decoration:none}a:link:not(.lit):hover{color:#00f;text-decoration:underline}a:link:active{color:red}h4{padding-right:1.25em}h4.noheading{margin-bottom:0}h1{text-align:center}code{padding:2px}pre{-moz-tab-size:4;-o-tab-size:4;tab-size:4}p:not(.notp){margin:0;text-indent:2em}.two-col{list-style-type:none}.two-col li:before{content:'-';padding:5px;margin-right:5px;color:orange;background-color:#fff;display:inline-block}@media print{body{font-size:10pt}pre.prettyprint{font-size:8pt}.seealso{font-size:9pt}.codeblock_name,.math,code{font-size:8pt}.math{text-indent:0}}
</style>
</head>
<body onload="prettyPrint()">
<section>
<h1>LFS: a primer</h1>
<a name="1:1"><div class="section"><h4>1. introduction</h4></a>
<p>in my experience, many network engineers lack an intuition about what linux is and how it works, despite its increasing importance in our field.
counting myself among them, i set out to deepen my understanding.
the foremost resource for that purpose is Linux From Scratch, but after skimming through the book, i felt that i first needed a higher level overview of the material.
this article is the result of that study.
</p>
<p>if you'd like to follow along, i suggest a clean install of ubuntu 22.04.3 LTS.
</p>

<div class="codeblock">
<span class="codeblock_name">{setup <a href="LFSp.html#1:1">1</a>}</span>
<pre class="prettyprint">
sudo apt install --yes qemu-system-x86-64 libguestfs-tools build-essential git bison flex libelf-dev libssl-dev libncurses5-dev
mkdir LFSp &amp;&amp; cd "$_"
</pre>



</div>
</div>
<a name="1:2"><div class="section"><h4>2. stage0 - running a linux kernel</h4></a>
<p>linux is a type of computer program called a kernel.
it acts as an interface between your hardware and "userland" - the programs you want to run.
it is not an operating system, and what exactly that means will become clear shortly.
when a linux system boots, the kernel is loaded into memory from a compressed image on disk.
that image, along with everything else required at boot time, can be found in the /boot directory on our ubuntu system.
</p>
<pre>
$ ls -hal /boot
total 302M
drwxr-xr-x  4 root root   19 Dec 30 06:28 .
drwxr-xr-x 19 root root   25 Dec 28 22:46 ..
-rw-r--r--  1 root root 270K Jul 13 14:22 config-6.2.0-26-generic
-rw-r--r--  1 root root 270K Nov 16 09:48 config-6.2.0-39-generic
drwxr-xr-x  4 root root 4.0K Jan  1  1970 efi
drwxr-xr-x  5 root root 4.0K Dec 30 06:26 grub
lrwxrwxrwx  1 root root   27 Dec 30 06:26 initrd.img -> initrd.img-6.2.0-39-generic
-rw-r--r--  1 root root 139M Dec 30 06:24 initrd.img-6.2.0-26-generic
-rw-r--r--  1 root root 132M Dec 30 06:28 initrd.img-6.2.0-39-generic
lrwxrwxrwx  1 root root   27 Dec 28 22:43 initrd.img.old -> initrd.img-6.2.0-26-generic
-rw-r--r--  1 root root 179K Feb  6  2022 memtest86+.bin
-rw-r--r--  1 root root 181K Feb  6  2022 memtest86+.elf
-rw-r--r--  1 root root 181K Feb  6  2022 memtest86+_multiboot.bin
-rw-------  1 root root 7.6M Jul 13 14:22 System.map-6.2.0-26-generic
-rw-------  1 root root 7.7M Nov 16 09:48 System.map-6.2.0-39-generic
lrwxrwxrwx  1 root root   24 Dec 30 06:26 vmlinuz -> vmlinuz-6.2.0-39-generic
-rw-r--r--  1 root root  14M Aug  8 00:05 vmlinuz-6.2.0-26-generic
-rw-r--r--  1 root root  14M Nov 16 09:50 vmlinuz-6.2.0-39-generic
lrwxrwxrwx  1 root root   24 Dec 30 06:26 vmlinuz.old -> vmlinuz-6.2.0-26-generic
</pre>
<p>in our case the kernel image is vmlinuz-6.2.0-39-generic.
check its permissions and ensure that it is readable.
if you are curious about the filename, it is an abbreviation of "Virtual Memory LINUx gZip".
so, what happens when we boot our kernel? to find out, we'll use a program called qemu.
</p>

<div class="codeblock">
<span class="codeblock_name">{stage0 boot <a href="LFSp.html#1:2">2</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -kernel /boot/vmlinuz
</pre>



</div>
<p><code>qemu-system-x86_64</code> is an emulator for IBM PC compatible systems using the amd64 processor - qemu can emulate many platforms, but this is what we will use.
we give it some memory with the <code>-m</code> flag, and it will very kindly load our kernel for us directly, allowing us to sidestep the hassle of creating a bootable disk image (for now).
in the new window that appears you will see rapidly scrolling output as the kernel boots, which stops just as rapidly when the kernel panics.
</p>

</div>
<a name="1:3"><div class="section"><h4>3. stage1 - mounting a root filesystem</h4></a>
<pre>
[    1.949579] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
</pre>
<p>the kernel is letting us know that it can't boot without a filesystem.
which device the kernel should use as the root filesystem is determined when the kernel is compiled from source, and to override that value we need to pass the <a href="https://man7.org/linux/man-pages/man7/bootparam.7.html">boot parameter</a> <code>root=</code> to the kernel.
we need to create a filesystem image to provide to qemu, which will make it available for our linux kernel to use.
there are many ways to do this, but the tool <code>virt-make-fs</code> is simple and effective, so we'll use it.
</p>

<div class="codeblock">
<span class="codeblock_name">{create rootfs <a href="LFSp.html#1:3">3</a>}</span>
<pre class="prettyprint">
mkdir rootfs
virt-make-fs --format=qcow2 --type=ext2 rootfs rootfs.ext2.qcow2
</pre>



</div>
<p>we create a directory <code>rootfs</code> and use <code>virt-make-fs</code> to turn it into an ext2 filesystem on a qcow2 disk image.
now we can let the kernel know about it's new root filesystem and try booting again:
</p>

<div class="codeblock">
<span class="codeblock_name">{stage1 boot <a href="LFSp.html#1:3">3</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -kernel /boot/vmlinuz -append "root=/dev/sda" -hda rootfs.ext2.qcow2 
</pre>



</div>
<p><code>-append</code> passes parameters to the kernel, and in this case it sets the value of "root" to the path "/dev/sda"
/dev is a directory on linux systems which contains special device files that represent devices attached to your system, such as hard drives.
sda represents the first SCSI disk; subsequent disks are named sdb, sdc et cetera.
<code>-hda</code> attaches our qcow2 image file to our linux system as a SCSI device.
this time, we hit a different panic
</p>

</div>
<a name="1:4"><div class="section"><h4>4. stage2 - executing an init program</h4></a>
<pre>
[    1.966493] Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst for guidance.
</pre>
<p>the kernel found our root filesystem, and looked there unsuccessfully for a program called "init".
init is a user level program which the kernel executes after it has finished booting. 
let's create our own example init program and see if our linux kernel will run it.
</p>

<div class="codeblock">
<span class="codeblock_name">{create simple init <a href="LFSp.html#1:4">4</a>}</span>
<pre class="prettyprint">
mkdir rootfs/sbin
gcc -static -o rootfs/sbin/init -x c - &lt;&lt; EOF
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

void main() {
    while(1){
      printf("Hello, World!\n");
      sleep(1);
    }
}
EOF
virt-make-fs --format=qcow2 --type=ext2 rootfs rootfs.ext2.qcow2
</pre>



</div>
<p>this is a simple c program that will print hello world every second in an infinite loop.
the details of the program and how it is compiled are not important for our purposes, but two points are worth noting: the program loops infinitely, because if it exits the kernel will panic, and we build the program statically.
this means that its dependencies are included in the resulting binary - it does not require access to any shared libraries.
this is important, because it is currently the only file on our disk.
we must name this program <code>init</code> and save it in the <code>/sbin</code> directory for linux to detect it automatically; alternatively we can provide the <code>init=</code> parameter to tell the kernel where to find it.
we also need to remember to recreate our rootfs disk image now that we've added a file to the directory it is built from.
</p>

<div class="codeblock">
<span class="codeblock_name">{stage2 boot <a href="LFSp.html#1:4">4</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -kernel /boot/vmlinuz -append "root=/dev/sda"  -hda rootfs.ext2.qcow2
</pre>



</div>
<p>admittedly it's not a very useful linux system, but we will fix that later.
more importantly, qemu has been giving us quite a leg up by booting our kernel directly for us, and that's not cricket.
</p>

</div>
<a name="1:5"><div class="section"><h4>5. stage3 - UEFI booting from disk</h4></a>
<p>almost all PCs made today have UEFI firmware instead of BIOS, so we will create a disk image that is bootable by UEFI.
the UEFI boot process is far more flexible than that of BIOS, and at a high level, quite simple.
the UEFI specification requires that compliant firmware must be able to read GPT partition tables, access FAT filesystems, and execute code that was written in a particular format.
</p>
<p>fortunately linux makes this easy with a feature called efistub.
</p>

<div class="codeblock">
<span class="codeblock_name">{create efi structure <a href="LFSp.html#1:5">5</a>}</span>
<pre class="prettyprint">
mkdir --parents rootfs/efi/boot
cp /boot/vmlinuz rootfs/efi/boot/bootx64.efi
virt-make-fs --format=qcow2 --type=fat rootfs rootfs.fat.qcow2
</pre>



</div>
<p>efi firmware expects a certain structure
bootx64.efi is always booted
</p>

<div class="codeblock">
<span class="codeblock_name">{stage3 boot <a href="LFSp.html#1:5">5</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -bios /usr/share/qemu/OVMF.fd -hda rootfs.fat.qcow2
</pre>



</div>
<p>let's try booting, but attentive readers will have already spotted the problem.
</p>

</div>
<a name="1:6"><div class="section"><h4>6. stage4 - creating an initramfs</h4></a>
<p>now that qemu is no longer booting our kernel for us, it can't pass along the required boot parameter.
the uefi firmware is able to find and boot our kernel image from the disk we provided, but we are again seeing a panic because the kernel doesn't know on what device to find the root filesystem.
we have a few options to fix this, but instead we will take this opportunity to introduce another method by which linux can boot: initramfs.
</p>

<div class="codeblock">
<span class="codeblock_name">{create initramfs <a href="LFSp.html#1:6">6</a>}</span>
<pre class="prettyprint">
mkdir --parents initramfs/efi/boot
cp rootfs/efi/boot/bootx64.efi initramfs/efi/boot/vmlinuz.efi
(
cd rootfs/sbin
echo init | cpio --quiet --create --format=newc | gzip &gt; ../../initramfs/initramfs_data.cpio.gz
)
</pre>



</div>
<p>we'll create a new directory for our initramfs, and give it that same structure that UEFI expects.
cpio reads a list of filenames from stdin and creates an archive containing them.
we then compress the archive with gzip and put it in the initramfs directory.
</p>

<div class="codeblock">
<span class="codeblock_name">{create initramfs <a href="LFSp.html#1:6">6</a>} +=</span>
<pre class="prettyprint">
cat &lt;&lt; EOF &gt; initramfs/startup.nsh
vmlinuz.efi initrd=initramfs_data.cpio.gz
EOF
virt-make-fs --format=qcow2 --type=fat initramfs initramfs.fat.qcow2
</pre>



</div>
<p>unfortunately, we still need to pass a parameter to the kernel, this time to tell it where the initramfs file is.
we can do this from the UEFI firmware shell, but having to do that manually on every boot would be inconvenient.
we needn't bother partitioning our disk, as our UEFI firmware will look for bootx64.efi on any FAT filesystem.
</p>

<div class="codeblock">
<span class="codeblock_name">{stage4 boot <a href="LFSp.html#1:6">6</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -bios /usr/share/qemu/OVMF.fd -hda initramfs.fat.qcow2 -net none
</pre>



</div>
<p>this works, but it is a bit of a hack. we should not be relying on startup.nsh to pass kernel parameters on boot.
we use <code>-net none</code> here just because the UEFI firmware will attempt a network boot, and we don't want to have to wait for that to time out. 
</p>

</div>
<a name="1:7"><div class="section"><h4>7. stage5 - building a custom kernel</h4></a>
<p>its time now to build our own kernel, into which we can embed our initramfs.
</p>
<p>clone the linux kernel git repository
</p>

<div class="codeblock">
<span class="codeblock_name">{build kernel <a href="LFSp.html#1:7">7</a>}</span>
<pre class="prettyprint">
git clone --depth 1 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</pre>



</div>
<p>we use <code>--depth 1</code> to create a shallow clone, pulling only the latest commit and not the entire history
</p>

<div class="codeblock">
<span class="codeblock_name">{build kernel <a href="LFSp.html#1:7">7</a>} +=</span>
<pre class="prettyprint">
cp rootfs/sbin/init linux/usr/
cat &lt;&lt; EOF &gt; linux/usr/initramfs_list
dir /dev 0755 0 0
nod /dev/console 0600 0 0 c 5 1
file /init usr/init 500 0 0
EOF

(
cd linux
make mrproper
make defconfig
scripts/config --set-str CONFIG_INITRAMFS_SOURCE usr/initramfs_list
scripts/config --enable CONFIG_CMDLINE_BOOL
scripts/config --set-str CONFIG_CMDLINE console=ttyS0
scripts/config --enable CONFIG_DRM_BOCHS
make olddefconfig
make -j "$(nproc)" --quiet
)

cp linux/arch/x86/boot/bzImage initramfs/efi/boot/bootx64.efi
virt-make-fs --format=qcow2 --type=fat initramfs initramfs.fat.qcow2
</pre>



</div>
<p>make olddefconfig updates our config with the new values we set, and also sets new symbols to their default value without prompting
</p>

<div class="codeblock">
<span class="codeblock_name">{stage5 boot <a href="LFSp.html#1:7">7</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -bios /usr/share/qemu/OVMF.fd -hda initramfs.fat.qcow2 -nographic
</pre>



</div>
<p>we now have to use <code>-nographic</code> because our custom linux kernel has not been built with support for graphics.
we are now successfully booting linux from disk via UEFI and running our custom init program from an initramfs!
exercise for the reader: make the output visible without -nographic
</p>

</div>
<a name="1:8"><div class="section"><h4>8. stage6 - busybox</h4></a>
<p>it's about time we set aside our example init program and installed something more useful. a great option for a minimal init is busybox. download a static binary from busybox.net
</p>

<div class="codeblock">
<span class="codeblock_name">{busybox initramfs <a href="LFSp.html#1:8">8</a>}</span>
<pre class="prettyprint">
(
cd linux
mkdir -p usr/initramfs_data/bin
cp ~/Downloads/busybox usr/initramfs_data/bin/
chmod +x usr/initramfs_data/bin/busybox

cat &lt;&lt; EOF &gt; usr/initramfs_data/init
#!/bin/busybox sh
/bin/busybox --install -s /bin/
exec sh
EOF
chmod +x usr/initramfs_data/init

cat &lt;&lt; EOF &gt; usr/initramfs_list
dir /dev 0755 0 0
nod /dev/console 0600 0 0 c 5 1
dir /bin 755 1000 1000
file /bin/busybox usr/initramfs_data/bin/busybox 755 0 0
slink /bin/sh busybox 777 0 0
file /init usr/initramfs_data/init 500 0 0
EOF
make -j "$(nproc)"
)

cp linux/arch/x86/boot/bzImage initramfs/efi/boot/bootx64.efi
virt-make-fs --format=qcow2 --type=fat initramfs initramfs.fat.qcow2
</pre>



</div>

<div class="codeblock">
<span class="codeblock_name">{stage6 boot <a href="LFSp.html#1:8">8</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -bios /usr/share/qemu/OVMF.fd -hda initramfs.fat.qcow2 -nographic
</pre>



</div>
<p>now we finally have a useful system.
exercise for the reader: create a bootable usb
</p>
<p>@ stage7 - switch_root
</p>

<div class="codeblock">
<span class="codeblock_name">{exec switch_root <a href="LFSp.html#1:8">8</a>}</span>
<pre class="prettyprint">
(
cd linux

cat &lt;&lt; EOF &gt; usr/initramfs_data/init
#!/bin/busybox sh
/bin/busybox --install -s /bin/
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mdev -s
mount /dev/sdb /mnt
exec switch_root /mnt /sbin/init
EOF
chmod +x usr/initramfs_data/init

cat &lt;&lt; EOF &gt; usr/initramfs_list
dir /proc 755 0 0
dir /sys 755 0 0
dir /mnt 755 0 0
dir /dev 0755 0 0
nod /dev/console 0600 0 0 c 5 1
dir /bin 755 1000 1000
file /bin/busybox usr/initramfs_data/bin/busybox 755 0 0
slink /bin/sh busybox 777 0 0
file /init usr/initramfs_data/init 500 0 0
EOF
make -j "$(nproc)"
)
cp linux/arch/x86/boot/bzImage initramfs/efi/boot/bootx64.efi
virt-make-fs --format=qcow2 --type=fat initramfs initramfs.fat.qcow2
virt-make-fs --format=qcow2 --type=ext2 rootfs rootfs.ext2.qcow2
</pre>



</div>

<div class="codeblock">
<span class="codeblock_name">{stage7 boot <a href="LFSp.html#1:8">8</a>}</span>
<pre class="prettyprint">
qemu-system-x86_64 -m 512M -bios /usr/share/qemu/OVMF.fd -hda initramfs.fat.qcow2 -hdb rootfs.ext2.qcow2 -nographic
</pre>



</div>
<p>exercise for the reader: create one disk with two partitions containing our initramfs and rootfs respectively.
</p>
<p>now we are ready to begin Linux From Scratch!
</p>
<p>write more detailed explanations
https://www.landley.net/writing/rootfs-intro.html
https://www.happyassassin.net/posts/2014/01/25/uefi-boot-how-does-that-actually-work-then/
https://superuser.com/questions/1657478/how-make-a-bootable-iso-for-my-uefi-application-bare-bones
https://stackoverflow.com/questions/57389189/create-pure-uefi-bootable-iso-from-directory
</p>



</div>
</body>
